# C# Client Guide (`Google.Cloud.Firestore`)

This guide explains how to use the C# code generated by FireSchema with the `Google.Cloud.Firestore` SDK for .NET applications (like ASP.NET Core, MAUI, Blazor, or Unity via .NET Standard 2.1).

## Prerequisites

-   You have defined your Firestore schema in `firestore.schema.json`.
-   You have configured a `csharp-client` output target in `fireschema.config.json`.
-   You have run `fireschema generate` to generate the C# code.
-   You have initialized `FirestoreDb` from the `Google.Cloud.Firestore` SDK in your application.

## Installation

Before using the generated code, ensure you have installed the necessary packages in your C# project:

1.  **Install the FireSchema C# Runtime:**
    ```bash
    dotnet add package FireSchema.CS.Runtime
    # Or via Package Manager Console:
    # Install-Package FireSchema.CS.Runtime
    ```
    This package provides the base classes (`BaseCollectionRef`, `BaseQueryBuilder`, `BaseUpdateBuilder`, etc.) and helpers required by the generated code.

2.  **Install the Google Cloud Firestore SDK:**
    ```bash
    dotnet add package Google.Cloud.Firestore
    ```
    This is the official SDK for interacting with Firestore from .NET.

## Core Concepts

The generated code provides the following key components:

-   **Typed Data Models:** Located typically in `Generated/Firestore/{CollectionName}/{CollectionName}Data.cs`. These classes represent the structure of your documents, including `Data` (for reading) and `AddData` (for creating new documents, often excluding read-only fields like `Id`).
-   **Typed Collection References:** Found in `Generated/Firestore/{CollectionName}/{CollectionName}Collection.cs`. These classes inherit from `BaseCollectionRef` and provide type-safe methods for CRUD operations (`GetAsync`, `AddAsync`, `SetAsync`, `UpdateAsync`, `DeleteAsync`) and for creating queries and accessing subcollections.
-   **Typed Query Builders:** Accessed via the `.Query()` method on a Collection Reference. These builders provide type-safe methods like `Where[FieldName]`, `OrderBy[FieldName]`, `Limit`, `StartAt`, `EndAt`, etc., corresponding to your schema fields.
-   **Typed Update Builders:** Accessed via the `.UpdateAsync(id)` method on a Collection Reference. These builders offer type-safe methods like `Set[FieldName]`, `Increment[FieldName]`, `Set[FieldName]ToServerTimestamp`, `DeleteField`, etc.

## Basic Usage Example

Let's assume you have a `users` collection defined in your schema.

```csharp
using Google.Cloud.Firestore;
using YourProject.Generated.Firestore; // Adjust to your generated code's namespace
using YourProject.Generated.Firestore.Users; // Adjust to your generated code's namespace
using System;
using System.Threading.Tasks;

public class FirestoreService
{
    private readonly FirestoreDb _firestoreDb;
    private readonly UsersCollection _usersCollection;

    public FirestoreService(string projectId)
    {
        _firestoreDb = FirestoreDb.Create(projectId);
        _usersCollection = new UsersCollection(_firestoreDb); // Instantiate the generated collection reference
    }

    public async Task RunExampleAsync(string userId = "user-csharp-example-123")
    {
        Console.WriteLine("--- C# FireSchema Example ---");

        // 1. Add a new user
        var newUser = new UsersAddData 
        { 
            DisplayName = "CSharp Example User", 
            Email = "csharp-example@example.com", 
            Age = 35,
            IsActive = true,
            // Assume 'CreatedAt' is handled by Firestore or default value
        };
        try
        {
            var newUserRef = await _usersCollection.AddAsync(newUser);
            userId = newUserRef.Id; // Use the generated ID for subsequent operations
            Console.WriteLine($"Successfully added user with ID: {userId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding user: {ex.Message}");
            return;
        }

        // 2. Get the user
        try
        {
            var fetchedUserDoc = await _usersCollection.GetAsync(userId);
            if (fetchedUserDoc != null)
            {
                Console.WriteLine($"Fetched User: ID={fetchedUserDoc.Id}, Name={fetchedUserDoc.Data.DisplayName}, Email={fetchedUserDoc.Data.Email}, Age={fetchedUserDoc.Data.Age}");
            }
            else
            {
                Console.WriteLine($"User with ID {userId} not found.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching user: {ex.Message}");
        }

        // 3. Query for active users
        try
        {
            Console.WriteLine("Querying for active users...");
            var activeUsers = await _usersCollection.Query()
                .WhereIsActive(FilterOperator.EqualTo, true) // Type-safe query based on 'IsActive' field
                .OrderByAge(QueryDirection.Descending)      // Type-safe ordering
                .Limit(5)
                .GetDataAsync();

            Console.WriteLine($"Found {activeUsers.Count} active user(s):");
            foreach (var userDoc in activeUsers)
            {
                Console.WriteLine($"- ID: {userDoc.Id}, Name: {userDoc.Data.DisplayName}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error querying users: {ex.Message}");
        }

        // 4. Update the user
        try
        {
            Console.WriteLine($"Updating user {userId}...");
            await _usersCollection.UpdateAsync(userId)
                .IncrementAge(1)                         // Type-safe increment
                .SetLastLogin(Timestamp.GetCurrentTimestamp()) // Type-safe server timestamp for 'LastLogin' field
                .CommitAsync();
            Console.WriteLine($"Successfully updated user {userId}.");

            // Verify update
            var updatedUserDoc = await _usersCollection.GetAsync(userId);
             if (updatedUserDoc != null)
            {
                 Console.WriteLine($"Verified Updated User: Age={updatedUserDoc.Data.Age}, LastLogin={updatedUserDoc.Data.LastLogin}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating user: {ex.Message}");
        }
        
        // 5. Delete the user (Optional Cleanup)
        // try
        // {
        //     Console.WriteLine($"Deleting user {userId}...");
        //     await _usersCollection.DeleteAsync(userId);
        //     Console.WriteLine($"Successfully deleted user {userId}.");
        // }
        // catch (Exception ex)
        // {
        //     Console.WriteLine($"Error deleting user: {ex.Message}");
        // }

        Console.WriteLine("--- Example Complete ---");
    }
}

// --- How to use the service ---
// var service = new FirestoreService("your-google-cloud-project-id");
// await service.RunExampleAsync();
```

## Next Steps

Explore the generated code for your specific collections to see all available methods on the Collection References, Query Builders, and Update Builders. Refer to the `Google.Cloud.Firestore` SDK documentation for more advanced Firestore features like transactions and batch writes, which can be used in conjunction with the generated code.