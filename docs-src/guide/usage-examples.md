# Usage Examples

Here's how you might use the code generated by FireSchema in your projects,
assuming you have initialized the relevant Firebase SDK (`firebase` client,
`firebase-admin`, or `cloud_firestore`) and installed the required runtime
libraries.

## TypeScript (Client SDK) Example

This example assumes you have generated code for the `typescript-client` target.

```typescript
import { FirebaseApp, initializeApp } from "firebase/app";
import {
    connectFirestoreEmulator,
    Firestore,
    getFirestore,
} from "firebase/firestore";
// Import generated collection class (adjust path based on your outputDir)
import { UsersCollection } from "../generated/firestore-ts-client/users.collection";
// Import generated data types if needed (often inferred)
import {
    UserAddData,
    UserData,
} from "../generated/firestore-ts-client/users.types";
// Firestore FieldValue types might still be needed directly for specific operations
import {
    arrayUnion,
    deleteField,
    increment,
    serverTimestamp,
} from "firebase/firestore";

// Example Firebase initialization (replace with your actual config)
const firebaseConfig = {
    apiKey: "...",
    authDomain: "...",
    projectId: "...",
    // ... other config
};
const app: FirebaseApp = initializeApp(firebaseConfig);
const firestore: Firestore = getFirestore(app);

// Optional: Connect to Firestore Emulator
// connectFirestoreEmulator(firestore, '127.0.0.1', 8080);

// Get a typed collection reference
const usersCollection = new UsersCollection(firestore); // Pass the Firestore instance

async function runClientExample() {
    try {
        console.log("Running TypeScript Client SDK Example...");

        // --- Add a new user ---
        // The AddData type excludes fields with defaultValues or read-only fields
        const newUser: UserAddData = {
            displayName: "Alice", // Required in schema
            email: "alice@example.com", // Required in schema
            age: 30,
            tags: ["beta", "tester"],
            settings: { theme: "dark", notificationsEnabled: false },
            // createdAt is optional (has serverTimestamp default, handled by runtime)
            // isActive is optional (has boolean default, handled by runtime)
        };
        const newUserRef = await usersCollection.add(newUser);
        console.log("Added user with ID:", newUserRef.id);

        // --- Get a user ---
        const aliceData: UserData | null = await usersCollection.get(
            newUserRef.id,
        );
        if (aliceData) {
            console.log(
                "Fetched user:",
                aliceData.displayName,
                aliceData.email,
            );
            console.log(
                "Fetched user's creation time:",
                aliceData.createdAt?.toDate(),
            ); // Timestamps are Firestore Timestamps
        }

        // --- Update a user using the type-safe UpdateBuilder ---
        await usersCollection.update(newUserRef.id)
            .incrementAge(1) // Generated method based on 'age' field
            .setLastLogin(serverTimestamp()) // Pass Firestore ServerTimestamp directly
            .setTags(arrayUnion("new-tag")) // Use arrayUnion/arrayRemove
            // .setSettings({ theme: 'light' }) // Update the whole map field
            .commit(); // commit() is inherited from runtime
        console.log(
            "Updated user age, last login, and tags via UpdateBuilder.",
        );

        // --- Query users ---
        // Type-safe where methods are generated for queryable fields
        const activeUsers = await usersCollection.query()
            .whereIsActive("==", true) // Generated method
            .whereAge(">=", 30) // Generated method
            .orderBy("displayName", "asc") // Inherited from runtime
            .limit(10) // Inherited from runtime
            .getData(); // getData() inherited from runtime

        console.log(`Found ${activeUsers.length} active users >= 30:`);
        activeUsers.forEach((user) =>
            console.log("-", user.displayName, user.id)
        );

        // --- Query using array-contains ---
        const betaTesters = await usersCollection.query()
            .whereTags("array-contains", "beta") // Generated method
            .getData();
        console.log(`Found ${betaTesters.length} beta testers.`);

        // --- Access a subcollection ---
        // Assuming 'posts' is defined as a subcollection under 'users' in your schema
        // and you generated code for it.
        // import { PostsCollection } from '../generated/firestore-ts-client/users/posts.collection';
        // import { PostAddData } from '../generated/firestore-ts-client/users/posts.types';

        // const userPostsCollection = usersCollection.posts(newUserRef.id); // Generated accessor
        // const newPost: PostAddData = { title: "My First Post", content: "Hello world!" };
        // await userPostsCollection.add(newPost);
        // console.log("Added post to subcollection.");

        // --- Using References ---
        // Assuming 'addresses' collection and 'primaryAddressRef' field on users
        // import { AddressesCollection } from '../generated/firestore-ts-client/addresses.collection';
        // import { AddressAddData } from '../generated/firestore-ts-client/addresses.types';
        // const addressesCollection = new AddressesCollection(firestore);
        // const newAddress: AddressAddData = { street: "123 Main St", city: "Anytown", zip: "12345" };
        // const newAddressRef = await addressesCollection.add(newAddress);
        // await usersCollection.update(newUserRef.id)
        //   .setPrimaryAddressRef(newAddressRef) // Pass the DocumentReference
        //   .commit();
        // console.log("Set user's primary address reference.");

        // const updatedUser = await usersCollection.get(newUserRef.id);
        // if (updatedUser?.primaryAddressRef) {
        //   console.log("User's primary address path:", updatedUser.primaryAddressRef.path);
        //   // Fetch the referenced document separately if needed
        //   // const addressDoc = await addressesCollection.get(updatedUser.primaryAddressRef.id);
        //   // console.log("Referenced Address:", addressDoc?.city);
        // }
    } catch (error) {
        console.error("Error running TypeScript Client SDK example:", error);
    }
}

runClientExample();
```

## TypeScript (Admin SDK) Example

This example assumes you have generated code for the `typescript-admin` target.
The usage is very similar to the Client SDK, but initialization and some types
differ.

```typescript
import * as admin from "firebase-admin";
// Import generated collection class (adjust path based on your outputDir)
import { UsersCollection } from "../generated/firestore-ts-admin/users.collection";
// Import generated data types if needed
import {
    UserAddData,
    UserData,
} from "../generated/firestore-ts-admin/users.types";
// Import Admin SDK specific types if needed directly
import { FieldValue, Timestamp } from "firebase-admin/firestore";

// Example Firebase Admin initialization (replace with your actual setup)
// admin.initializeApp({
//   credential: admin.credential.applicationDefault(), // Or use a service account key
// });
// const firestore = admin.firestore();
// firestore.settings({ host: "127.0.0.1:8080", ssl: false }); // Connect to emulator if needed

// Assume firestore is initialized
declare const firestore: admin.firestore.Firestore;

// Get a typed collection reference
const usersCollection = new UsersCollection(firestore); // Pass the Admin Firestore instance

async function runAdminExample() {
    try {
        console.log("Running TypeScript Admin SDK Example...");

        // --- Add a new user ---
        const newUser: UserAddData = {
            displayName: "Admin User",
            email: "admin@example.com",
            age: 50,
            // Other fields omitted if they have defaults or are optional
        };
        const newUserRef = await usersCollection.add(newUser);
        console.log("Added admin user with ID:", newUserRef.id);

        // --- Get a user ---
        const adminUserData: UserData | null = await usersCollection.get(
            newUserRef.id,
        );
        if (adminUserData) {
            console.log("Fetched admin user:", adminUserData.displayName);
            // Timestamps are admin Timestamps
            console.log(
                "Admin user created:",
                adminUserData.createdAt?.toDate(),
            );
        }

        // --- Update a user ---
        await usersCollection.update(newUserRef.id)
            .incrementAge(5)
            .setLastLogin(FieldValue.serverTimestamp()) // Use Admin FieldValue
            .commit();
        console.log("Updated admin user via UpdateBuilder.");

        // --- Query users ---
        const highAgeUsers = await usersCollection.query()
            .whereAge(">", 40)
            .orderBy("age", "desc")
            .limit(5)
            .getData(); // getData() works the same

        console.log(`Found ${highAgeUsers.length} users over 40:`);
        highAgeUsers.forEach((user) =>
            console.log("-", user.displayName, user.age)
        );
    } catch (error) {
        console.error("Error running TypeScript Admin SDK example:", error);
    }
}

// runAdminExample(); // Uncomment to run
```

## Dart (Client SDK) Example

This example assumes you have generated code for the `dart-client` target.

```dart
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_core/firebase_core.dart'; // For initialization

// Import generated files (adjust path based on your outputDir)
import 'generated/firestore_dart/users_collection.dart';
import 'generated/firestore_dart/users_data.dart';
// Import subcollection files if needed
// import 'generated/firestore_dart/users/posts_collection.dart';
// import 'generated/firestore_dart/users/posts_data.dart';

// Assume Firebase is initialized:
// await Firebase.initializeApp(
//   options: DefaultFirebaseOptions.currentPlatform, // From flutterfire_cli
// );
// final firestore = FirebaseFirestore.instance;
// firestore.useFirestoreEmulator('127.0.0.1', 8080); // Optional: Use emulator

// Assume firestore instance is available
declare const FirebaseFirestore firestore;

void main() async {
  print('Running Dart Client SDK Example...');

  // Get a typed collection reference
  final usersCollection = UsersCollection(firestore: firestore); // Use named param

  try {
    // --- Add a new user ---
    // Use the generated AddData class constructor.
    // Only fields required in schema AND without a defaultValue are required here.
    final newUser = UsersAddData(
      displayName: 'Bob',
      email: 'bob@example.com',
      // createdAt is optional (has serverTimestamp default, handled by runtime)
      // isActive is optional (has boolean default, handled by runtime)
      age: 42,
      tags: ['alpha'],
      settings: {'theme': 'system'},
    );
    // The add method handles applying serverTimestamp if createdAt is null (via runtime)
    final newUserRef = await usersCollection.add(newUser);
    print('Added user with ID: ${newUserRef.id}');

    // --- Get a user ---
    final bobData = await usersCollection.get(newUserRef.id); // get() inherited
    if (bobData != null) {
      print('Fetched user: ${bobData.displayName}, ${bobData.email}');
      print('Fetched user created at: ${bobData.createdAt?.toDate()}');
    }

    // --- Update a user using the type-safe UpdateBuilder ---
    await usersCollection.update(newUserRef.id) // update() inherited/implemented
      .incrementAge(1) // Generated method uses runtime logic
      .setLastLoginToServerTimestamp() // Generated method uses runtime logic
      // .setTags(FieldValue.arrayUnion(['new-dart-tag'])) // Use FieldValue for complex updates
      .commit(); // commit() inherited from runtime
    print('Updated user age and last login via UpdateBuilder.');

    // --- Query users ---
    // Use the generated QueryBuilder with type-safe where methods
    final activeUsers = await usersCollection.query() // query() inherited/implemented
        .whereIsActive(isEqualTo: true) // Generated method
        .whereAge(isGreaterThanOrEqualTo: 40) // Generated method
        .orderBy('displayName') // Inherited from runtime
        .limit(10) // Inherited from runtime
        .getData(); // getData() inherited from runtime

    print('Found ${activeUsers.length} active users >= 40:');
    activeUsers.forEach((user) => print('- ${user.displayName} (ID: ${user.id})'));

    // --- Query using array-contains ---
    final alphaTesters = await usersCollection.query()
        .whereTags(arrayContains: 'alpha') // Generated method
        .getData();
    print('Found ${alphaTesters.length} alpha testers.');

    // --- Pagination / Cursor Example ---
    // Methods inherited from runtime
    // final firstPageSnap = await usersCollection.query().orderBy('age').limit(2).get();
    // if (firstPageSnap.docs.isNotEmpty) {
    //     final lastDocSnapshot = firstPageSnap.docs.last;
    //     final nextPageData = await usersCollection.query().orderBy('age').startAfterDocument(lastDocSnapshot).limit(2).getData();
    //     print('Next page users count: ${nextPageData.length}');
    // }

    // --- Access a subcollection ---
    // Assuming 'posts' subcollection exists
    // final userPostsCollection = usersCollection.posts(newUserRef.id); // Generated accessor
    // final newPost = PostsAddData(title: 'My Dart Post', content: 'Hello Dart!');
    // await userPostsCollection.add(newPost);
    // print('Added post to subcollection.');

    // --- Using References ---
    // Assuming 'addresses' collection and 'primaryAddressRef' field
    // import 'generated/firestore_dart/addresses_collection.dart';
    // import 'generated/firestore_dart/addresses_data.dart';
    // final addressesCollection = AddressesCollection(firestore: firestore);
    // final newAddress = AddressesAddData(street: '456 Dart Ln', city: 'Flutterville');
    // final newAddressRef = await addressesCollection.add(newAddress);
    // await usersCollection.update(newUserRef.id)
    //   .setPrimaryAddressRef(newAddressRef) // Pass the DocumentReference
    //   .commit();
    // print('Set user primary address ref.');

    // final updatedUser = await usersCollection.get(newUserRef.id);
    // if (updatedUser?.primaryAddressRef != null) {
    //   print('User address path: ${updatedUser!.primaryAddressRef!.path}');
    //   // Fetch separately if needed
    //   // final addressSnap = await updatedUser.primaryAddressRef!.get();
    //   // final addressData = AddressesData.fromSnapshot(addressSnap); // Use generated fromSnapshot
    //   // print('Referenced Address City: ${addressData.city}');
    // }

  } catch (e) {
    print('Error running Dart example: $e');
  }
}

// main(); // Uncomment to run
```
