# Technical Context: FireSchema (Executor + Adapter Refactor)

**Core Generator Tool (`@shtse8/fireschema`):**

- **Language:** TypeScript
- **Runtime:** Node.js (for CLI execution via `npx`)
- **Key Libraries:**
  - `commander`: CLI argument parsing and command structure.
  - `ajv`: JSON Schema validation for user-provided schema files.
  - `ejs`: Templating engine (used _by_ adapters, not directly by the core
    tool).
- **Compilation:** TypeScript compiled to JavaScript (`dist/` directory).
- **Monorepo Structure:** Uses npm workspaces to manage the core tool and
  runtime packages (`packages/*`).
- **Core Logic:**
  - `src/cli.ts`: Entry point, parses commands.
  - `src/configLoader.ts`: Loads and validates `fireschema.config.json`,
    including the new `target` property.
  - `src/schemaLoader.ts`: Loads and validates `firestore.schema.json`.
  - `src/generator.ts` (**Executor**): Orchestrates the generation process.
    Reads config, determines target, dynamically loads the appropriate internal
    adapter module (from `src/adapters/`), and calls its `generate` function.
  - `src/adapters/`: Contains internal adapter modules (e.g.,
    `typescript-client/index.ts`, `typescript-admin/index.ts`,
    `dart-client/index.ts`) responsible for handling specific targets. Each
    adapter loads its own templates from a subdirectory (e.g.,
    `src/adapters/typescript-client/templates/`).
  - `templates/`: (DEPRECATED for TS) Contains EJS templates for Dart (will
    likely move too).

**Schema Definition:**

- **Format:** JSON Schema (Draft 7 recommended).
- **File:** User-defined (e.g., `firestore.schema.json`).
- **Validation:** Validated against `src/schema-definition.json` using `ajv`.

**Configuration (`fireschema.config.json`):**

- **Format:** JSON.
- **File:** User-defined, specified via `-c` flag.
- **Structure:**
  - `schema`: Path to the schema file.
  - `outputs`: Array of output target objects.
    - `target`: **Required string** identifying the generation target (e.g.,
      `'typescript-client'`, `'typescript-admin'`, `'dart-client'`). This
      replaces the old `language` and `sdk` properties.
    - `outputDir`: Path for generated code.
    - `package`: Optional info for generating `package.json`/`pubspec.yaml`.
    - `options`: Optional object for target-specific settings (e.g.,
      `dateTimeType` for TS).

**Runtime Libraries (Separate Packages):**

- **Purpose:** Contain reusable base classes, generic types, and SDK interaction
  logic needed by the code generated by specific adapters. Installed by the
  end-user.
- **TypeScript Runtime (Independent Packages):**
  - **`@shtse8/fireschema-ts-client-runtime`:**
    - **Location:** `packages/fireschema-ts-client-runtime`
    - **Purpose:** Implements base classes and logic using the `firebase`
      (Client) SDK v9+. Fully self-contained.
    - **Used by:** Code generated by `typescript-client` adapter.
    - **Published:** As an npm package.
    - **Dependencies:** `firebase`.
  - **`@shtse8/fireschema-ts-admin-runtime`:**
    - **Location:** `packages/fireschema-ts-admin-runtime`
    - **Purpose:** Implements base classes and logic using the `firebase-admin`
      SDK. Fully self-contained.
    - **Used by:** Code generated by `typescript-admin` adapter.
    - **Published:** As an npm package.
    - **Dependencies:** `firebase-admin`.
- **Dart Runtime (`fireschema_dart_runtime`):**
  - Located in `packages/fireschema_dart_runtime`.
  - Provides equivalent base classes/mixins for Dart.
  - Used by code generated by the `dart-client` adapter.
  - Published as a pub package.
  - **Dependencies:** `cloud_firestore`, `meta`.

**Generated Code Targets (Examples):**

1. **Target: `'typescript-client'`**
   - **Adapter:** `src/adapters/typescript-client/index.ts`.
   - **Templates:** Uses templates from
     `src/adapters/typescript-client/templates/`.
   - **Dependencies (User Project):** `@shtse8/fireschema-ts-client-runtime`,
     `firebase`.
   - **Output Files:** `*.types.ts`, `*.collection.ts`, `*.query.ts`,
     `*.update.ts`. Generated code imports from and extends classes in
     `@shtse8/fireschema-ts-client-runtime`.
2. **Target: `'typescript-admin'`**
   - **Adapter:** `src/adapters/typescript-admin/index.ts`.
   - **Templates:** Uses templates from
     `src/adapters/typescript-admin/templates/`.
   - **Dependencies (User Project):** `@shtse8/fireschema-ts-admin-runtime`,
     `firebase-admin`.
   - **Output Files:** `*.types.ts`, `*.collection.ts`, `*.query.ts`,
     `*.update.ts`. Generated code imports from and extends classes in
     `@shtse8/fireschema-ts-admin-runtime`.
3. **Target: `'dart-client'`** (Unaffected by TS Runtime split)
   - **Adapter:** `src/adapters/dart-client/index.ts`.
   - **Dependencies (User Project):** `fireschema_dart_runtime` +
     `cloud_firestore`.
   - **Output Files:** `*_data.dart`, `*_collection.dart`, `*_query.dart`,
     `*_update.dart`. Generated code uses base classes/mixins from the runtime.

**Development Environment:**

- **Primary Tooling:** Bun (`bun`) for development tasks.
- **User Compatibility:** Published CLI tool (`@shtse8/fireschema`) and runtime
  packages remain compatible with standard Node.js/Dart/Flutter environments.

**Testing Strategy:**

- **Core Tool (`@shtse8/fireschema`):**
  - **Snapshot Tests:** Located in `src/__tests__/generator.test.ts`. Executes
    the CLI for different targets and compares the generated file content
    against stored snapshots. Verifies Adapter + Template output structure.
  - **Unit Tests:** For utility functions like config/schema loaders (if
    needed).
- **Runtime Packages (e.g., `ts-client-runtime`, `ts-admin-runtime`,
  `dart-runtime`):**
  - **Unit Tests:** Located within each runtime package (e.g.,
    `packages/fireschema-ts-client-runtime/src/__tests__/`). Test internal logic
    of base classes using Jest (TS) or `flutter test` (Dart).
    - **TS Testing Setup:** Uses `babel-jest` transformer configured via
      `babel.config.cjs` in each TS runtime package. Tests are run using
      `npx jest` due to issues with `bun test`.
  - **Integration Tests:** Located within each runtime package (e.g.,
    `packages/fireschema-ts-client-runtime/tests/integration/`). These tests
    perform end-to-end validation:
    1. Use the corresponding Adapter to generate sample code during test setup.
    2. Import the generated code and the runtime package itself.
    3. Connect to a Firestore Emulator.
    4. Execute CRUD and query operations using the generated ODM classes.
    5. Assert against the data in the emulator.
- **Adapters (`src/adapters/*`):**
  - Primarily tested via the core tool's Snapshot Tests.
  - Can include specific Unit Tests for complex internal helper functions if
    necessary.

**Documentation:**

- **Framework:** VitePress
- **Source:** Markdown files located in `docs-src/`.
- **Configuration:** `docs-src/.vitepress/config.mts`.
- **Build Output:** Static HTML site generated into the root `docs/` directory
  (configured via `outDir` in `config.mts`).
- **Scripts:**
  - `docs:dev`: Local development server.
  - `docs:build`: Builds the static site.
  - `docs:preview`: Previews the production build locally.

**Publishing & CI/CD:**

- **Automation:** GitHub Actions workflow (`.github/workflows/publish.yml`)
  triggered on version tags (`v*.*.*`).
- **Workflow Steps:**
  - Installs dependencies (`bun install`).
  - Builds all packages (`bun run build`).
  - Runs tests (`npx jest`).
  - Builds documentation (`npm run docs:build`).
  - Uploads documentation build artifact (`docs/` directory).
  - Publishes npm packages (`@shtse8/fireschema`,
    `@shtse8/fireschema-ts-client-runtime`,
    `@shtse8/fireschema-ts-admin-runtime`) using `secrets.NPM_TOKEN`.
  - Publishes Dart package (`fireschema_dart_runtime`) using
    `dart-lang/setup-dart` reusable workflow.
  - Deploys documentation artifact to GitHub Pages (`gh-pages` branch) using
    `peaceiris/actions-gh-pages`.
