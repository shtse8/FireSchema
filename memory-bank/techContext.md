# Technical Context: FireSchema (Separate Repos + Submodules)

**Core Generator Tool (`@shtse8/fireschema`):**

- **Language:** TypeScript
- **Runtime:** Node.js (for CLI execution via `npx`)
- **Key Libraries:**
  - `commander`: CLI argument parsing and command structure.
  - `ajv`: JSON Schema validation for user-provided schema files.
  - `ejs`: Templating engine (used _by_ adapters, not directly by the core
    tool).
- **Compilation:** TypeScript compiled to JavaScript (`dist/` directory).
- **Repository Structure:** Main repository (`firestore-odm`) contains the core CLI tool, documentation, and examples. Runtime packages are included as **Git submodules** in the `packages/` directory, linking to their separate repositories.
- **Core Logic:**
  - `src/cli.ts`: Entry point, parses commands.
  - `src/configLoader.ts`: Loads and validates `fireschema.config.json`,
    including the new `target` property.
  - `src/schemaLoader.ts`: Loads and validates `firestore.schema.json`.
  - `src/generator.ts` (**Executor**): Orchestrates the generation process.
    Reads config, determines target, dynamically loads the appropriate internal
    adapter module (from `src/adapters/`), and calls its `generate` function.
  - `src/adapters/`: Contains internal adapter modules (e.g.,
    `typescript-client/index.ts`, `typescript-admin/index.ts`,
    `dart-client/index.ts`) responsible for handling specific targets. Each
    adapter loads its own templates from a subdirectory (e.g.,
    `src/adapters/typescript-client/templates/`).
  - `templates/`: (DEPRECATED for TS) Contains EJS templates for Dart (will
    likely move too).

**Schema Definition:**

- **Format:** JSON Schema (Draft 7 recommended).
- **File:** User-defined (e.g., `firestore.schema.json`).
- **Validation:** Validated against `src/schema-definition.json` using `ajv`.

**Configuration (`fireschema.config.json`):**

- **Format:** JSON.
- **File:** User-defined, specified via `-c` flag.
- **Structure:**
  - `schema`: Path to the schema file.
  - `outputs`: Array of output target objects.
    - `target`: **Required string** identifying the generation target (e.g.,
      `'typescript-client'`, `'typescript-admin'`, `'dart-client'`). This
      replaces the old `language` and `sdk` properties.
    - `outputDir`: Path for generated code.
    - `package`: Optional info for generating `package.json`/`pubspec.yaml`.
    - `options`: Optional object for target-specific settings (e.g.,
      `dateTimeType` for TS).

**Runtime Libraries (Separate Repositories & Submodules):**

- **Purpose:** Contain reusable base classes, generic types, and SDK interaction
  logic needed by the code generated by specific adapters. Installed by the
  end-user.
- **TypeScript Runtime (Independent Packages):**
  - **`@shtse8/fireschema-ts-client-runtime`:**
    - **Location:** `packages/fireschema-ts-client-runtime` (Submodule linking to `fireschema-ts-client-runtime` repo)
    - **Purpose:** Implements base classes and logic using the `firebase`
      (Client) SDK v9+. Fully self-contained.
    - **Used by:** Code generated by `typescript-client` adapter.
    - **Published:** As an npm package (from its own repo).
    - **Dependencies:** `firebase`.
  - **`@shtse8/fireschema-ts-admin-runtime`:**
    - **Location:** `packages/fireschema-ts-admin-runtime` (Submodule linking to `fireschema-ts-admin-runtime` repo)
    - **Purpose:** Implements base classes and logic using the `firebase-admin`
      SDK. Fully self-contained.
    - **Used by:** Code generated by `typescript-admin` adapter.
    - **Published:** As an npm package (from its own repo).
    - **Dependencies:** `firebase-admin`.
- **Dart Runtime (`fireschema_dart_runtime`):**
  - **Location:** `packages/fireschema_dart_runtime` (Submodule linking to `fireschema_dart_runtime` repo)
  - Provides equivalent base classes/mixins for Dart.
  - Used by code generated by the `dart-client` adapter.
  - Published as a pub package (from its own repo).
  - **Dependencies:** `cloud_firestore`, `meta`.

**Generated Code Targets (Examples):**

1.  **Target: `'typescript-client'`**
   - **Adapter:** `src/adapters/typescript-client/index.ts`.
   - **Templates:** Uses templates from
     `src/adapters/typescript-client/templates/`.
   - **Dependencies (User Project):** `@shtse8/fireschema-ts-client-runtime`,
     `firebase`.
   - **Output Files:** `*.types.ts`, `*.collection.ts`, `*.query.ts`,
     `*.update.ts`. Generated code imports from and extends classes in
     `@shtse8/fireschema-ts-client-runtime`.
2.  **Target: `'typescript-admin'`**
   - **Adapter:** `src/adapters/typescript-admin/index.ts`.
   - **Templates:** Uses templates from
     `src/adapters/typescript-admin/templates/`.
   - **Dependencies (User Project):** `@shtse8/fireschema-ts-admin-runtime`,
     `firebase-admin`.
   - **Output Files:** `*.types.ts`, `*.collection.ts`, `*.query.ts`,
     `*.update.ts`. Generated code imports from and extends classes in
     `@shtse8/fireschema-ts-admin-runtime`.
3.  **Target: `'dart-client'`**
   - **Adapter:** `src/adapters/dart-client/index.ts`.
   - **Dependencies (User Project):** `fireschema_dart_runtime` +
     `cloud_firestore`.
   - **Output Files:** `*_data.dart`, `*_collection.dart`, `*_query.dart`,
     `*_update.dart`. Generated code uses base classes/mixins from the runtime.

**Development Environment:**

- **Primary Tooling:** Bun (`bun`) for development tasks in the main repo. Individual runtime repos might use Bun or npm/dart pub.
- **User Compatibility:** Published CLI tool (`@shtse8/fireschema`) and runtime
  packages remain compatible with standard Node.js/Dart/Flutter environments.

**Testing Strategy:**

- **Core Tool (`@shtse8/fireschema`):**
  - **Snapshot Tests:** Located in `src/__tests__/generator.test.ts`. Executes
    the CLI for different targets and compares the generated file content
    against stored snapshots. Verifies Adapter + Template output structure.
  - **Unit Tests:** For utility functions like config/schema loaders (if
    needed).
- **Runtime Packages (e.g., `ts-client-runtime`, `ts-admin-runtime`,
  `dart-runtime`):**
  - **Unit & Integration Tests:** Located **within each runtime package's own repository**. These tests are run independently.
  - **TS Testing Setup:** Uses Jest configured via `jest.config.cjs` or similar in each TS runtime package.
  - **Dart Testing Setup:** Uses `dart test` configured via `pubspec.yaml`.
- **Adapters (`src/adapters/*`):**
  - Primarily tested via the core tool's Snapshot Tests.
  - Can include specific Unit Tests for complex internal helper functions if
    necessary.

**Documentation:**

- **Framework:** VitePress
- **Source:** Markdown files located in `docs-src/`.
- **Configuration:** `docs-src/.vitepress/config.mts`.
- **Build Output:** Static HTML site generated into the root `docs/` directory
  (configured via `outDir` in `config.mts`).
- **Scripts:**
  - `docs:dev`: Local development server.
  - `docs:build`: Builds the static site.
  - `docs:preview`: Previews the production build locally.

**Publishing & CI/CD:**

- **Automation:** GitHub Actions workflows.
- **Main Repo (`firestore-odm`):**
    - Workflow (`.github/workflows/publish.yml`) triggers on push/PR to `main`.
    - Checks out code including submodules.
    - Builds and tests the core CLI tool.
    - Builds documentation.
    - Deploys documentation to GitHub Pages.
    - **Does NOT publish any packages.**
- **Runtime Repos (e.g., `fireschema-ts-client-runtime`):**
    - Each runtime repository has its **own separate GitHub Actions workflow**.
    - These workflows trigger on Git tags created **in that specific repository** (e.g., `vX.Y.Z` or `ts-client-vX.Y.Z`).
    - Workflows build, test, and publish **only that specific package** to its respective registry (npm or pub.dev).
