# Technical Context: FireSchema (Executor + Adapter Refactor)

**Core Generator Tool (`@shtse8/fireschema`):**

- **Language:** TypeScript
- **Runtime:** Node.js (for CLI execution via `npx`)
- **Key Libraries:**
  - `commander`: CLI argument parsing and command structure.
  - `ajv`: JSON Schema validation for user-provided schema files.
  - `ejs`: Templating engine (used _by_ adapters, not directly by the core
    tool).
- **Compilation:** TypeScript compiled to JavaScript (`dist/` directory).
- **Monorepo Structure:** Uses npm workspaces to manage the core tool and
  runtime packages (`packages/*`).
- **Core Logic:**
  - `src/cli.ts`: Entry point, parses commands.
  - `src/configLoader.ts`: Loads and validates `fireschema.config.json`,
    including the new `target` property.
  - `src/schemaLoader.ts`: Loads and validates `firestore.schema.json`.
  - `src/generator.ts` (**Executor**): Orchestrates the generation process.
    Reads config, determines target, dynamically loads the appropriate internal
    adapter module (from `src/adapters/`), and calls its `generate` function.
  - `src/adapters/`: Contains internal adapter modules (e.g., `typescript.ts`,
    `dart.ts`) responsible for handling specific targets.
  - `templates/`: Contains EJS templates used by the internal adapters.

**Schema Definition:**

- **Format:** JSON Schema (Draft 7 recommended).
- **File:** User-defined (e.g., `firestore.schema.json`).
- **Validation:** Validated against `src/schema-definition.json` using `ajv`.

**Configuration (`fireschema.config.json`):**

- **Format:** JSON.
- **File:** User-defined, specified via `-c` flag.
- **Structure:**
  - `schema`: Path to the schema file.
  - `outputs`: Array of output target objects.
    - `target`: **Required string** identifying the generation target (e.g.,
      `'typescript-client'`, `'typescript-admin'`, `'dart-client'`). This
      replaces the old `language` and `sdk` properties.
    - `outputDir`: Path for generated code.
    - `package`: Optional info for generating `package.json`/`pubspec.yaml`.
    - `options`: Optional object for target-specific settings (e.g.,
      `dateTimeType` for TS).

**Runtime Libraries (Separate Packages):**

- **Purpose:** Contain reusable base classes, generic types, and SDK interaction
  logic needed by the code generated by specific adapters. Installed by the
  end-user.
- **TypeScript Runtime (`@shtse8/fireschema-runtime`):**
  - Located in `packages/fireschema-ts-runtime`.
  - Provides base classes (`BaseCollectionRef`, `BaseQueryBuilder`,
    `BaseUpdateBuilder`) and generic types (`FirestoreLike`,
    `DocumentReferenceLike`, `TimestampLike`, etc.).
  - Internally handles differences between `firebase` (client) and
    `firebase-admin` (server) SDKs.
  - Used by code generated by `typescript-client` and `typescript-admin`
    adapters.
  - Published as an npm package.
  - **Peer Dependencies:** `firebase` (optional), `firebase-admin` (optional).
- **Dart Runtime (`fireschema_dart_runtime`):**
  - Located in `packages/fireschema_dart_runtime`.
  - Provides equivalent base classes/mixins for Dart.
  - Used by code generated by the `dart-client` adapter.
  - Published as a pub package.
  - **Dependencies:** `cloud_firestore`, `meta`.

**Generated Code Targets (Examples):**

1. **Target: `'typescript-client'` / `'typescript-admin'`**
   - **Adapter:** `src/adapters/typescript.ts` (handles both client/admin based
     on target string).
   - **Dependencies (User Project):** `@shtse8/fireschema-runtime` + (`firebase`
     OR `firebase-admin`).
   - **Output Files:** `*.types.ts`, `*.collection.ts`, `*.query.ts`,
     `*.update.ts`. Generated code uses generic types and base classes from the
     runtime. Templates use an `sdk` flag (derived from `target` by the adapter)
     for conditional imports.
2. **Target: `'dart-client'`**
   - **Adapter:** `src/adapters/dart.ts`.
   - **Dependencies (User Project):** `fireschema_dart_runtime` +
     `cloud_firestore`.
   - **Output Files:** `*_data.dart`, `*_collection.dart`, `*_query.dart`,
     `*_update.dart`. Generated code uses base classes/mixins from the runtime.

**Development Environment:**

- **Primary Tooling:** Bun (`bun`) for development tasks.
- **User Compatibility:** Published CLI tool (`@shtse8/fireschema`) and runtime
  packages remain compatible with standard Node.js/Dart/Flutter environments.

**Testing:**

- **Runtime Unit Tests:** Jest for TS runtime, `flutter test` for Dart runtime.
  (TS tests require `npx jest` due to `bun test` limitations with `jest.mock`).
- **Generator Output Verification:** Snapshot tests
  (`src/__tests__/generator.test.ts`) execute the compiled CLI with different
  `target` configurations and compare output against snapshots.

**Publishing & CI/CD:**

- **Automation:** GitHub Actions workflow publishes the core tool
  (`@shtse8/fireschema`) and the two runtime packages
  (`@shtse8/fireschema-runtime`, `fireschema_dart_runtime`) on version tags.
